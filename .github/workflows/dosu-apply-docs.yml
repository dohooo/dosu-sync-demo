name: Dosu Apply Docs

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number'
        required: true
        type: string
      items:
        description: 'Items to apply'
        required: true
        type: string
      total_items:
        description: 'Total items count'
        required: true
        type: string
      comment_id:
        description: 'Bot comment ID to update'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  apply-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Apply documentation updates
        run: |
          echo "Applying items: ${{ inputs.items }} for PR #${{ inputs.pr_number }}"
          echo "" >> README.md
          echo "---" >> README.md
          echo "## Documentation Sync" >> README.md
          echo "PR: #${{ inputs.pr_number }}" >> README.md
          echo "Items: ${{ inputs.items }}" >> README.md
          echo "Synced at: $(date -u)" >> README.md

      - name: Commit and push
        run: |
          git config user.name "dosu-bot"
          git config user.email "bot@dosu.dev"
          git add .
          git diff --staged --quiet || git commit -m "docs: sync via Dosu (PR #${{ inputs.pr_number }})"
          git push

      - name: Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = ${{ inputs.comment_id }};
            const items = '${{ inputs.items }}'.split(',').map(n => parseInt(n));
            const total = parseInt('${{ inputs.total_items }}');
            
            const { data: comment } = await github.rest.issues.getComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId
            });
            
            let body = comment.body;
            body = body.replace(/\n---\n\*\*Status:?\*\*[\s\S]*$/m, '');
            
            for (let i = 1; i <= total; i++) {
              if (items.includes(i)) {
                body = body.replace(new RegExp(`- \\[[ x]\\] \\*\\*#${i}\\*\\*`, 'i'), `- :white_check_mark: **#${i}**`);
              } else {
                body = body.replace(new RegExp(`- \\[[ x]\\] \\*\\*#${i}\\*\\*`, 'i'), `- :wastebasket: **#${i}**`);
              }
            }
            
            body += `\n---\n**Resolved** - Documentation sync completed.\n`;
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body
            });
